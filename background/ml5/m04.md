# Transfer Learning with Feature Extractor
- [Feature extraction](https://en.wikipedia.org/wiki/Feature_extraction)
- [Transfer learning](https://en.wikipedia.org/wiki/Transfer_learning)
- [Teachable Machine](https://teachablemachine.withgoogle.com/)


---

- `index.html`

```html
<!DOCTYPE html>
<html>
  <head>
    <title>ml5.js 연습</title>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/p5@1/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1/lib/addons/p5.sound.min.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/IDMNYU/p5.js-speech@0.0.3/lib/p5.speech.js"></script>
  </head>

  <body>
    <h1>Feature Extractor</h1>
    <script src="sketch.js"></script>
  </body>
</html>
```

---

- `sketch.js` (0) - custom image classification
  - [ ] 배경이 단일색으로 가능한 한 단순해야 할 것
  - [ ] 사람의 신체 부위가 지나치게 개입된 상태로 이미지 추가 하지 말 것
  - [ ] 개입된 사람의 신체에 비하여 상대적으로 작은 물체는 판별하기 어려움


```javascript
let mobilenet;  // pre-trained model
let classifier; // user's model
let video;
let label = 'test';
let button1;  // object 1
let button2;  // object 2
let button3;  // train

function setup() {
  createCanvas(640, 550);
  video = createCapture(VIDEO);
  video.hide();
  mobilenet = ml5.featureExtractor('MobileNet', modelReady);
  classifier = mobilenet.classification(video, videoReady);
  
  button1 = createButton('object 1');
  button2 = createButton('object 2');
  button3 = createButton('train');
  
  button1.mousePressed(addImage1);
  button2.mousePressed(addImage2);
  button3.mousePressed(trainImage);
}

function modelReady() {
  console.log('Model is ready!');
}

function videoReady() {
  console.log('Video is ready!');
}

function gotResults(error, results) { 
  if (error) {
      console.log(error);
  } else {
      label = results[0].label;
      mobilenet.classify(gotResults);
  }
}

function addImage1() {
  console.log('Object 1 is added!');
  classifier.addImage('object 1');
}

function addImage2() {
  console.log('Object 2 is added!');
  classifier.addImage('object 2');
}

function trainImage() {
  console.log('Image training stars!');
  classifier.train(whileTraining);
}

function whileTraining(loss) {
  // 오차함수 (error function, loss function, cost function)
  if (loss == null) {
    console.log('Training finished!');
    classifier.classify(gotResults);
  } else {
    console.log(loss);  
  }
}

function gotResults(error, results) { 
  if (error) {
      console.log(error);
  } else {
      label = results[0].label;
      classifier.classify(gotResults);
  }
}

function draw() {
  background(0);
  image(video, 0, 0);
  fill(0, 255, 255);
  textSize(32);
  text(label, 10, height - 20);
}
```

---

- [ ] 실습: 행복한(happy) 표정과 슬픈(sad) 표정을 학습시키고 인공지능이 나의 감정 상태를 구별하도록 해보자. (과장된 표정일수록 좋은 성능)


---

- `sketch.js` (1) Save/load custom model
  - [ ] `model.json`(메타화일)과 `model.weights.bin`(이진화일) 디폴트 다운로드 디렉토리로 다운로드
  - [ ] Linux `mv` 명령어 사용하여 현재 작업 디렉토리로 이동시 기존의 같은 이름의 화일들은 덮어쓰기 되므로 주의할 것 


  ```sh
  pwd  # 현재 작업 디렉토리 (이후 명령어에서 간단히 . 을 대신 사용함)
  mv 디폴트 다운로드 디렉토리/model.json .
  mv 디폴트 다운로드 디렉토리/model.weights.bin .
  ```

```javascript

```


---






- `sketch.js` (4)

```javascript
// Feature Extractor for regression

let mobilenet;
let classifier;
let video;
let label;
let trainButton;
let slider;

function modelReady() {
    console.log('Model is ready!');
}

function videoReady() {
  console.log('Video is ready!');
}

function whileTraining(loss) {
  if (loss == null) {
    console.log('Training Complete');
    classifier.classify(gotResults);
  } else {
    console.log(loss);
  }
}

function gotResults(error, results) { 
    if (error) {
        console.log(error);
    } else {
        label = results[0].label;
        classifier.classify(gotResults);
    }
}



function setup() {
    createCanvas(640, 550);
    video = createCapture(VIDEO);
    video.hide();
    mobilenet = ml5.featureExtractor('MobileNet', modelReady);  // feature extraction
    classifier = mobilenet.regression(video, videoReady); // regression based on features

    slider = createSlider(0, 1, 0.5, 0.01);
    slider.input(function() {
      console.log(slider.value());
    });

    trainButton = createButton('train');
    trainButton.mousePressed(function() {
      classifier.train(whileTraining); // callback
    });
}

function draw() {
    background(0);
    image(video, 0, 0);
    fill(0, 255, 255);
    textSize(32);
    text(label, 10, height - 20);
}  
```


---

- `sketch.js` (5)

```javascript
// Feature Extractor for regression

let mobilenet;
let predictor;
let video;
let val = 0;
let trainButton;
let slider;
let addButton;

function modelReady() {
    console.log('Model is ready!');
}

function videoReady() {
  console.log('Video is ready!');
}

function whileTraining(loss) {
  if (loss == null) {
    console.log('Training Complete');
    predictor.predict(gotResults);
  } else {
    console.log(loss);
  }
}

function gotResults(error, results) { 
    if (error) {
        console.log(error);
    } else {
        val = results.value;
        console.log(val);
        predictor.predict(gotResults);
    }
}



function setup() {
    createCanvas(640, 550);
    video = createCapture(VIDEO);
    video.hide();
    mobilenet = ml5.featureExtractor('MobileNet', modelReady);  // feature extraction
    predictor = mobilenet.regression(video, videoReady); // regression based on features

    slider = createSlider(0, 1, 0.5, 0.01);  
    
    addButton = createButton('add example image');
    addButton.mousePressed(function() {
      predictor.addImage(slider.value());
    });


    trainButton = createButton('train');
    trainButton.mousePressed(function() {
      predictor.train(whileTraining); // callback
    });
}

function draw() {
    background(0);
    image(video, 0, 0);
    fill(0, 255, 255);
    textSize(32);
    text(val, 10, height - 20);
}  
```


---

- `sketch.js` (6)

```javascript
let mobilenet;
let predictor;
let video;
let val = 0;
let trainButton;
let slider;
let addButton;

function modelReady() {
    console.log('Model is ready!');
}

function videoReady() {
  console.log('Video is ready!');
}

function whileTraining(loss) {
  if (loss == null) {
    console.log('Training Complete');
    predictor.predict(gotResults);
  } else {
    console.log(loss);
  }
}

function gotResults(error, results) { 
    if (error) {
        console.log(error);
    } else {
        val = results.value;
        console.log(val);
        predictor.predict(gotResults);
    }
}



function setup() {
    createCanvas(640, 550);
    video = createCapture(VIDEO);
    video.hide();
    mobilenet = ml5.featureExtractor('MobileNet', modelReady);  // feature extraction
    predictor = mobilenet.regression(video, videoReady); // regression based on features

    slider = createSlider(0, 1, 0.5, 0.01);  
    
    addButton = createButton('add example image');
    addButton.mousePressed(function() {
      predictor.addImage(slider.value());
    });


    trainButton = createButton('train');
    trainButton.mousePressed(function() {
      predictor.train(whileTraining); // callback
    });
}

function draw() {
    background(0);
    image(video, 0, 0, 640, 480);
    rectMode(CENTER);
    fill(255, 0, 200);
    rect(val*width, height/2, 50, 50);

    fill(0, 255, 255);
    textSize(32);
    text(val, 10, height - 20);
}  
```


---


- `sketch.js` (7)

```javascript
// Feature Extractor (Save/Load Model: Classification)

let mobilenet;
let classifier;
let video;
let label = 'Test';
let obj1Button;
let obj2leButton;
let trainButton;
let saveButton;

function modelReady() {
    console.log('Model is ready!');
}

function videoReady() {
  console.log('Video is ready!');
}

function whileTraining(loss) {
  if (loss == null) {
    console.log('Training Complete');
    classifier.classify(gotResults);
  } else {
    console.log(loss);
  }
}

function gotResults(error, results) { 
    if (error) {
        console.log(error);
    } else {
        label = results[0].label;
        classifier.classify(gotResults);
    }
}



function setup() {
    createCanvas(640, 550);
    video = createCapture(VIDEO);
    video.hide();
    mobilenet = ml5.featureExtractor('MobileNet', modelReady);  // feature extraction
    classifier = mobilenet.classification(video, videoReady); // classification based on features

    obj1Button = createButton('obj1');
    obj1Button.mousePressed(function() {
      classifier.addImage('obj1');
    });

    obj2Button = createButton('obj2');
    obj2Button.mousePressed(function() {
      classifier.addImage('obj2');
    });

    trainButton = createButton('train');
    trainButton.mousePressed(function() {
      classifier.train(whileTraining); // callback
    });


    saveButton = createButton('save');
    saveButton.mousePressed(function() {
      classifier.save();
    });
}

function draw() {
    background(0);
    image(video, 0, 0);
    fill(0, 255, 255);
    textSize(32);
    text(label, 10, height - 20);
} 
```

---

- `sketch.js` (8)

```javascript
// Feature Extractor (Save/Load Model: Classification)

let mobilenet;
let classifier;
let video;
let label = 'loading model';
// let obj1Button;
// let obj2leButton;
// let trainButton;
// let saveButton;

function modelReady() {
  console.log('Model is ready!');
  classifier.load('model.json', customModelReady);
}

function customModelReady() {
  console.log('Custom Model is ready!!!');
  label = 'Custom model is ready';
  classifier.classify(gotResults);
}

function videoReady() {
  console.log('Video is ready!');
}

// function whileTraining(loss) {
//   if (loss == null) {
//     console.log('Training Complete');
//     classifier.classify(gotResults);
//   } else {
//     console.log(loss);
//   }
// }

function gotResults(error, results) { 
    if (error) {
        console.log(error);
    } else {
        label = results[0].label;
        classifier.classify(gotResults);
    }
}



function setup() {
    createCanvas(640, 550);
    video = createCapture(VIDEO);
    video.hide();
    mobilenet = ml5.featureExtractor('MobileNet', modelReady);  // feature extraction
    classifier = mobilenet.classification(video, videoReady); // classification based on features

    // obj1Button = createButton('obj1');
    // obj1Button.mousePressed(function() {
    //   classifier.addImage('obj1');
    // });

    // obj2Button = createButton('obj2');
    // obj2Button.mousePressed(function() {
    //   classifier.addImage('obj2');
    // });

    // trainButton = createButton('train');
    // trainButton.mousePressed(function() {
    //   classifier.train(whileTraining); // callback
    // });


    // saveButton = createButton('save');
    // saveButton.mousePressed(function() {
    //   classifier.save();
    // });
}

function draw() {
    background(0);
    image(video, 0, 0);
    fill(0, 255, 255);
    textSize(32);
    text(label, 10, height - 20);
} 
```
